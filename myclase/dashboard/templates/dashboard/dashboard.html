{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Mis Ventas{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-800">Dashboard del Vendedor</h1>
    
    <!-- Cards de estadísticas -->
  
    
    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Ventas por día (últimos 7 días) -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Ventas de los últimos 7 días</h2>
            <canvas id="dailySalesChart"></canvas>
        </div>
        
        <!-- Ventas por mes -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Ventas mensuales</h2>
            <canvas id="monthlySalesChart"></canvas>
        </div>
    </div>
    
    <!-- Top productos y transacciones recientes -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top 5 productos -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-black-800">Productos más vendidos</h2>
            <div class="space-y-4">
                {% for product in top_products %}
                <div class="datosCard flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex-1">
                        <p class="datoTitulo font-semibold text-black">{{ product.product__title }}</p>
                        <p class="datoDetail text-sm text-black">{{ product.total_quantity }} unidades vendidas</p>
                    </div>
                    <div class="text-right">
                        <p class="datoPrecio font-bold text-black">${{ product.total_revenue|floatformat:2 }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-black text-center py-4">No hay ventas registradas aún</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Transacciones recientes -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 tituloDatos">Transacciones recientes</h2>
            <div class="space-y-3">
                {% for sale in recent_transactions %}
                <div class="datosCard flex items-center justify-between p-3 border-l-4 
                    {% if sale.status == 'completed' %}border-green-500 bg-green-50
                    {% elif sale.status == 'pending' %}border-yellow-500 bg-yellow-50
                    {% else %}border-red-500 bg-red-50{% endif %} rounded-r-lg">
                    <div class="flex-1">
                        <p class="datoTitulo font-semibold text-black">{{ sale.product.title }}</p>
                        <p class="datoDetail text-sm text-black">
                            Cliente: {{ sale.buyer.username }} | 
                            {{ sale.quantity }} unidad{% if sale.quantity > 1 %}es{% endif %}
                        </p>
                        <p class="datoDetailtext-xs text-black">{{ sale.created_at|date:"d/m/Y H:i" }}</p>
                    </div>
                    <div class="text-right">
                        <p class="datoPrecio font-bold text-black">${{ sale.total_price|floatformat:2 }}</p>
                        <span class="text-xs px-2 py-1 rounded-full
                            {% if sale.status == 'completed' %} completada
                            {% elif sale.status == 'pending' %} pendiente
                            {% else %}cancelada{% endif %}">
                            {{ sale.get_status_display }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <p class="datoDetail text-black text-center py-4">No hay transacciones recientes</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para ventas diarias
const dailyLabels = [{% for sale in recent_sales %}'{{ sale.date|date:"d/m" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
const dailyData = [{% for sale in recent_sales %}{{ sale.total|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];

// Gráfico de ventas diarias
const dailyCtx = document.getElementById('dailySalesChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: 'Ingresos ($)',
            data: dailyData,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value;
                    }
                }
            }
        }
    }
});

// Datos para ventas mensuales
const monthlyLabels = [{% for sale in monthly_sales %}'{{ sale.month|date:"M Y" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
const monthlyData = [{% for sale in monthly_sales %}{{ sale.total|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];

// Gráfico de ventas mensuales
const monthlyCtx = document.getElementById('monthlySalesChart').getContext('2d');
new Chart(monthlyCtx, {
    type: 'bar',
    data: {
        labels: monthlyLabels,
        datasets: [{
            label: 'Ingresos ($)',
            data: monthlyData,
            backgroundColor: 'rgba(34, 197, 94, 0.7)',
            borderColor: 'rgb(34, 197, 94)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value;
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}