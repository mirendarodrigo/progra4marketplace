{% extends "base.html" %}
{% block title %}Mi perfil{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card p-4 p-md-5">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h1 class="h4 mb-1">
            {% if mode == 'staff_preview' %}
              Vista de campos (Admin)
            {% else %}
              Editar mi perfil
            {% endif %}
          </h1>
          <div class="text-muted">
            {% if mode == 'staff_preview' %}
              Campos vacíos, sólo lectura. Ingresá con una cuenta de usuario para editar.
            {% else %}
              Completá tus datos y guardá los cambios.
            {% endif %}
          </div>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="row g-4">
          <!-- Columna avatar -->
          <div class="col-md-4 text-center">
            <div class="mb-3">
              {% if mode == 'user_edit' and pform.instance.foto %}
                <img id="avatarPreview" src="{{ pform.instance.foto.url }}" class="avatar" alt="Foto de perfil">
              {% else %}
                <img id="avatarPreview" src="https://ui-avatars.com/api/?name={{ request.user.get_full_name|urlencode }}&size=256" class="avatar" alt="Foto">
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label">Foto de perfil</label>
              {{ pform.foto }}
              {% for e in pform.foto.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            {% if mode == 'user_edit' and pform.instance.foto %}
              <a href="{% url 'profiles:delete_photo' %}" class="btn btn-outline-danger btn-soft btn-sm">Borrar foto</a>
            {% endif %}
          </div>

          <!-- Columna datos -->
          <div class="col-md-8">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                {{ uform.first_name }}
                {% for e in uform.first_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellido</label>
                {{ uform.last_name }}
                {% for e in uform.last_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>

              <div class="col-md-6">
                <label class="form-label">Teléfono</label>
                {{ pform.telefono }}
                {% for e in pform.telefono.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Localidad</label>
                {{ pform.localidad }}
                {% for e in pform.localidad.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <label class="form-label">Dirección</label>
                {{ pform.direccion }}
                {% for e in pform.direccion.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <label class="form-label">Datos personales</label>
                {{ pform.datos_personales }}
                {% for e in pform.datos_personales.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>
          </div>
        </div>

        {% if mode != 'staff_preview' %}
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary btn-soft px-4">Guardar cambios</button>
          </div>
        {% else %}
          <div class="alert alert-info mt-4 mb-0">
            Estás viendo una previsualización (admin). No se puede guardar desde aquí.
          </div>
        {% endif %}
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Preview de imagen al seleccionar archivo
  const fileInput = document.getElementById('{{ pform.foto.id_for_label }}');
  const preview   = document.getElementById('avatarPreview');
  if (fileInput && preview) {
    fileInput.addEventListener('change', (e) => {
      const [file] = e.target.files || [];
      if (file) preview.src = URL.createObjectURL(file);
    });
  }
</script>
{% endblock %}
